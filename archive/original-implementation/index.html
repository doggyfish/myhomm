<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    <title>MyHoMM - Heroes of Might and Magic</title>
    <link rel="stylesheet" href="src/tactical/tactical-ui-styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #ffffff;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        /* Game container */
        .game-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* Game header */
        .game-header {
            background: rgba(0, 0, 0, 0.9);
            padding: env(safe-area-inset-top, 10px) 20px 10px;
            border-bottom: 2px solid #ff6b35;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(255, 107, 53, 0.3);
        }
        
        .game-title {
            color: #ff6b35;
            font-size: clamp(18px, 4vw, 28px);
            font-weight: bold;
            text-shadow: 0 0 15px rgba(255, 107, 53, 0.8);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .game-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .control-btn {
            background: linear-gradient(45deg, #4CAF50, #66BB6A);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        
        .control-btn:hover {
            background: linear-gradient(45deg, #66BB6A, #4CAF50);
            transform: translateY(-2px);
        }
        
        .control-btn.secondary {
            background: linear-gradient(45deg, #2196F3, #42A5F5);
        }
        
        .control-btn.secondary:hover {
            background: linear-gradient(45deg, #42A5F5, #2196F3);
        }
        
        /* Main game area */
        .game-main {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            background: #1a1a2e;
            border: none;
            touch-action: none;
            image-rendering: crisp-edges;
        }
        
        /* Game HUD */
        .game-hud {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px;
            border-radius: 12px;
            font-size: 14px;
            z-index: 100;
            min-width: 200px;
            border: 1px solid #4CAF50;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.2);
        }
        
        .hud-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
            padding: 5px 0;
        }
        
        .hud-section:not(:last-child) {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .hud-label {
            color: #B0BEC5;
            font-weight: 500;
        }
        
        .hud-value {
            color: #ffffff;
            font-weight: bold;
        }
        
        .hud-value.gold {
            color: #FFD700;
        }
        
        .hud-value.population {
            color: #4CAF50;
        }
        
        .hud-value.power {
            color: #ff6b35;
        }
        
        /* Game status */
        .game-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px;
            border-radius: 12px;
            font-size: 12px;
            z-index: 100;
            max-width: 250px;
            border: 1px solid #2196F3;
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.2);
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active {
            background: #4CAF50;
            box-shadow: 0 0 8px #4CAF50;
        }
        
        .status-inactive {
            background: #f44336;
        }
        
        /* Selection info */
        .selection-info {
            position: absolute;
            bottom: env(safe-area-inset-bottom, 20px);
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px;
            border-radius: 12px;
            font-size: 12px;
            z-index: 100;
            min-width: 280px;
            border: 1px solid #9C27B0;
            box-shadow: 0 4px 20px rgba(156, 39, 176, 0.2);
            display: none;
        }
        
        .selection-info.visible {
            display: block;
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Notification area */
        .notification-area {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 400px;
            z-index: 2000;
            pointer-events: none;
        }
        
        .game-notification {
            background: rgba(33, 150, 243, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 14px;
            text-align: center;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4);
        }
        
        .game-notification.success {
            background: rgba(76, 175, 80, 0.95);
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
        }
        
        .game-notification.error {
            background: rgba(244, 67, 54, 0.95);
            box-shadow: 0 4px 20px rgba(244, 67, 54, 0.4);
        }
        
        .game-notification.warning {
            background: rgba(255, 152, 0, 0.95);
            box-shadow: 0 4px 20px rgba(255, 152, 0, 0.4);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Loading screen */
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 5000;
            transition: opacity 0.5s ease;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-logo {
            font-size: 48px;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .loading-title {
            font-size: 32px;
            color: #ff6b35;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(255, 107, 53, 0.8);
        }
        
        .loading-subtitle {
            font-size: 16px;
            color: #B0BEC5;
            margin-bottom: 30px;
        }
        
        .loading-progress {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .loading-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35, #f7931e);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .loading-text {
            font-size: 14px;
            color: #E0E0E0;
            text-align: center;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .game-header {
                padding: env(safe-area-inset-top, 5px) 15px 5px;
            }
            
            .game-title {
                font-size: 20px;
            }
            
            .control-btn {
                padding: 6px 12px;
                font-size: 11px;
                min-height: 40px;
            }
            
            .game-hud, .game-status, .selection-info {
                font-size: 11px;
                padding: 12px;
            }
            
            .loading-title {
                font-size: 24px;
            }
            
            .loading-progress {
                width: 250px;
            }
        }
        
        @media (orientation: landscape) and (max-height: 500px) {
            .game-header {
                padding: 5px 15px;
            }
            
            .game-title {
                font-size: 18px;
            }
            
            .loading-logo {
                font-size: 32px;
                margin-bottom: 15px;
            }
            
            .loading-title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">🏰</div>
        <div class="loading-title">MyHoMM</div>
        <div class="loading-subtitle">Heroes of Might and Magic</div>
        <div class="loading-progress">
            <div class="loading-fill" id="loadingFill"></div>
        </div>
        <div class="loading-text" id="loadingText">Initializing game systems...</div>
    </div>

    <!-- Main Game -->
    <div class="game-container" id="gameContainer">
        <div class="game-header">
            <div class="game-title">
                <span>🏰</span>
                <span>MyHoMM</span>
            </div>
            <div class="game-controls">
                <button class="control-btn" onclick="togglePause()">
                    <span id="pauseIcon">⏸️</span>
                    <span id="pauseText">Pause</span>
                </button>
                <button class="control-btn secondary" onclick="showGameMenu()">
                    ⚙️ Menu
                </button>
                <button class="control-btn secondary" onclick="toggleTacticalPanel()">
                    ⚔️ Tactical
                </button>
            </div>
        </div>
        
        <div class="game-main">
            <canvas id="gameCanvas" width="1200" height="800"></canvas>
            
            <!-- Game HUD -->
            <div class="game-hud" id="gameHUD">
                <div class="hud-section">
                    <span class="hud-label">👑 Player:</span>
                    <span class="hud-value" id="playerName">Human Player</span>
                </div>
                <div class="hud-section">
                    <span class="hud-label">💰 Gold:</span>
                    <span class="hud-value gold" id="playerGold">100</span>
                </div>
                <div class="hud-section">
                    <span class="hud-label">🏰 Castles:</span>
                    <span class="hud-value" id="playerCastles">1</span>
                </div>
                <div class="hud-section">
                    <span class="hud-label">👥 Population:</span>
                    <span class="hud-value population" id="playerPopulation">0</span>
                </div>
                <div class="hud-section">
                    <span class="hud-label">⚔️ Total Power:</span>
                    <span class="hud-value power" id="playerPower">0</span>
                </div>
            </div>
            
            <!-- Game Status -->
            <div class="game-status" id="gameStatus">
                <div><span class="status-indicator status-inactive"></span>Game Systems: Loading...</div>
                <div id="mobileStatus">Mobile: Detecting...</div>
                <div id="tacticalStatus">Tactical: Inactive</div>
                <div id="aiStatus">AI Players: 0</div>
                <div id="gameTime">Time: 00:00</div>
            </div>
            
            <!-- Selection Info -->
            <div class="selection-info" id="selectionInfo">
                <div class="selection-header">
                    <h4 id="selectionTitle">Nothing Selected</h4>
                </div>
                <div class="selection-details" id="selectionDetails">
                    Click on a castle or army to see details
                </div>
            </div>
        </div>
        
        <!-- Notification Area -->
        <div class="notification-area" id="notificationArea"></div>
    </div>

    <!-- Load platform detection and system loader first -->
    <script src="src/core/PlatformDetector.js" onload="console.log('✅ PlatformDetector.js loaded')" onerror="console.error('❌ PlatformDetector.js failed')"></script>
    <script src="src/core/SystemLoader.js" onload="console.log('✅ SystemLoader.js loaded')" onerror="console.error('❌ SystemLoader.js failed')"></script>
    
    <!-- Always load core systems -->
    <script src="src/entities/Player.js" onload="console.log('✅ Player.js loaded')" onerror="console.error('❌ Player.js failed')"></script>
    <script>if (typeof Player !== 'undefined') console.log('✅ Player class available'); else console.error('❌ Player class NOT available after script load');</script>
    <script src="src/entities/Castle.js" onload="console.log('✅ Castle.js loaded')" onerror="console.error('❌ Castle.js failed')"></script>
    <script>if (typeof Castle !== 'undefined') console.log('✅ Castle class available'); else console.error('❌ Castle class NOT available after script load');</script>
    <script src="src/entities/Army.js" onload="console.log('✅ Army.js loaded')" onerror="console.error('❌ Army.js failed')"></script>
    <script>if (typeof Army !== 'undefined') console.log('✅ Army class available'); else console.error('❌ Army class NOT available after script load');</script>
    <script src="src/systems/ProductionSystem.js" onload="console.log('✅ ProductionSystem.js loaded')" onerror="console.error('❌ ProductionSystem.js failed')"></script>
    <script src="src/systems/CombatSystem.js" onload="console.log('✅ CombatSystem.js loaded')" onerror="console.error('❌ CombatSystem.js failed')"></script>
    <script src="src/systems/MovementSystem.js" onload="console.log('✅ MovementSystem.js loaded')" onerror="console.error('❌ MovementSystem.js failed')"></script>
    <script src="src/systems/AISystem.js" onload="console.log('✅ AISystem.js loaded')" onerror="console.error('❌ AISystem.js failed')"></script>
    <script src="src/ui/InputHandler.js" onload="console.log('✅ InputHandler.js loaded')" onerror="console.error('❌ InputHandler.js failed')"></script>
    <script src="src/ui/Renderer.js" onload="console.log('✅ Renderer.js loaded')" onerror="console.error('❌ Renderer.js failed')"></script>
    <script src="src/core/Game.js" onload="console.log('✅ Game.js loaded')" onerror="console.error('❌ Game.js failed')"></script>
    <script>if (typeof Game !== 'undefined') console.log('✅ Game class available'); else console.error('❌ Game class NOT available after script load');</script>
    
    <!-- Conditionally load mobile systems -->
    <script>
        // Initialize platform detection
        const platformDetector = new PlatformDetector();
        const systemLoader = new SystemLoader(platformDetector);
        
        // Only load mobile systems if needed
        if (platformDetector.shouldUseMobileMode()) {
            console.log('📱 Loading mobile systems for mobile/tablet device');
            
            // Load mobile scripts dynamically
            const mobileScripts = [
                'src/mobile/MobileOptimizer.js',
                'src/mobile/TouchManager.js',
                'src/mobile/MobilePerformanceManager.js',
                'src/mobile/MobileUIManager.js',
                'src/mobile/MobileCombatSystem.js',
                'src/mobile/MobileGameManager.js'
            ];
            
            mobileScripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                script.async = false; // Maintain load order
                document.head.appendChild(script);
            });
        } else {
            console.log('🖥️ Desktop mode - mobile systems not loaded');
        }
        
        // Only load tactical systems if supported
        if (platformDetector.shouldUseTacticalSystems()) {
            console.log('⚔️ Loading tactical systems');
            
            const tacticalScripts = [
                'src/tactical/TacticalCombatSystem.js',
                'src/tactical/TacticalUIManager.js', 
                'src/tactical/CastleSpecializationSystem.js'
            ];
            
            tacticalScripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                script.async = false;
                document.head.appendChild(script);
            });
        } else {
            console.log('⚠️ Tactical systems not supported on this device');
        }
    </script>

    <script>
        // Main game instance
        let game = null;
        let gameInitialized = false;
        let gameRunning = false;
        let gamePaused = false;
        
        // Game state
        let gameStartTime = Date.now();
        let lastUpdateTime = Date.now();
        
        // UI update intervals
        let hudUpdateInterval = null;
        let statusUpdateInterval = null;
        
        /**
         * Initialize the complete game with platform-aware system loading
         */
        async function initializeGame() {
            try {
                updateLoadingProgress(10, "Detecting platform...");
                
                // Wait for all scripts to load
                console.log('🔍 Pre-load diagnostics:');
                logScriptLoadingDiagnostics();
                await waitForScriptsToLoad();
                console.log('🔍 Post-load diagnostics:');
                logScriptLoadingDiagnostics();
                
                updateLoadingProgress(20, "Loading systems...");
                
                // Load appropriate systems for platform
                const systemStatus = await systemLoader.loadAllSystems();
                
                if (!systemStatus.success) {
                    throw new Error(`System loading failed: ${systemStatus.error}`);
                }
                
                updateLoadingProgress(40, "Creating game instance...");
                
                // Create game instance with platform-appropriate systems
                game = systemLoader.createGameInstance('gameCanvas');
                
                // Log platform information
                const platformInfo = platformDetector.getDebugInfo();
                console.log('🔍 Platform info:', platformInfo);
                
                updateLoadingProgress(60, "Initializing game systems...");
                
                // Initialize systems based on what was loaded
                await initializePlatformSystems();
                
                updateLoadingProgress(80, "Setting up game world...");
                
                // Setup initial game state
                setupInitialGameState();
                
                updateLoadingProgress(90, "Starting game loop...");
                
                // Start game loop
                startGameLoop();
                
                // Setup UI
                setupGameUI();
                
                updateLoadingProgress(100, "Game ready!");
                
                // Show platform-specific welcome message
                const platformMessage = getPlatformWelcomeMessage();
                
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    gameInitialized = true;
                    gameRunning = true;
                    
                    showNotification(platformMessage, "success", 5000);
                }, 500);
                
            } catch (error) {
                console.error('Game initialization failed:', error);
                updateLoadingProgress(0, `Initialization failed: ${error.message}`);
                showNotification("❌ Game initialization failed. Please refresh the page.", "error", 10000);
            }
        }
        
        /**
         * Wait for dynamically loaded scripts to be available
         */
        async function waitForScriptsToLoad() {
            const maxWaitTime = 5000; // 5 seconds max
            const checkInterval = 100; // Check every 100ms
            let waitTime = 0;
            
            // Define all required core classes that must be loaded
            const coreClasses = [
                'PlatformDetector', 'SystemLoader', 
                'Player', 'Castle', 'Army',
                'ProductionSystem', 'CombatSystem', 'MovementSystem', 'AISystem',
                'InputHandler', 'Renderer', 'Game'
            ];
            
            while (waitTime < maxWaitTime) {
                let allLoaded = true;
                const missingClasses = [];
                
                // Check all core classes first
                for (const className of coreClasses) {
                    if (typeof window[className] === 'undefined') {
                        allLoaded = false;
                        missingClasses.push(className);
                    }
                }
                
                // Check if mobile systems are loaded (if needed)
                if (platformDetector.shouldUseMobileMode()) {
                    const mobileClasses = ['MobileOptimizer', 'TouchManager', 'MobileGameManager'];
                    for (const className of mobileClasses) {
                        if (typeof window[className] === 'undefined') {
                            allLoaded = false;
                            missingClasses.push(className);
                        }
                    }
                }
                
                // Check if tactical systems are loaded (if needed)
                if (platformDetector.shouldUseTacticalSystems()) {
                    const tacticalClasses = ['TacticalCombatSystem', 'TacticalUIManager'];
                    for (const className of tacticalClasses) {
                        if (typeof window[className] === 'undefined') {
                            allLoaded = false;
                            missingClasses.push(className);
                        }
                    }
                }
                
                if (allLoaded) {
                    console.log('✅ All required scripts loaded successfully');
                    console.log(`📋 Core classes available: ${coreClasses.filter(c => typeof window[c] !== 'undefined').length}/${coreClasses.length}`);
                    return;
                }
                
                // Log missing classes every second for debugging
                if (waitTime % 1000 === 0 && missingClasses.length > 0) {
                    console.log(`⏳ Waiting for classes: ${missingClasses.join(', ')}`);
                }
                
                await new Promise(resolve => setTimeout(resolve, checkInterval));
                waitTime += checkInterval;
            }
            
            // Final check and detailed reporting
            const finalMissing = [];
            for (const className of coreClasses) {
                if (typeof window[className] === 'undefined') {
                    finalMissing.push(className);
                }
            }
            
            if (finalMissing.length > 0) {
                console.error('❌ Failed to load required classes:', finalMissing);
                console.warn('⚠️ Game may not function properly with missing classes');
            } else {
                console.log('✅ All core classes loaded after timeout');
            }
        }
        
        /**
         * Initialize platform-specific systems
         */
        async function initializePlatformSystems() {
            const systemStatus = systemLoader.getSystemStatus();
            
            console.log('🎮 Initializing systems for:', systemStatus.platform);
            console.log('📊 System status:', systemStatus);
            
            // Mobile systems initialization
            if (systemStatus.mobileModeActive && systemStatus.loadedSystems.includes('MobileGameManager')) {
                try {
                    // Mobile systems are initialized by SystemLoader
                    showNotification("📱 Mobile systems active", "success");
                } catch (error) {
                    console.error('❌ Mobile systems initialization failed:', error);
                    showNotification("⚠️ Mobile features limited", "warning");
                }
            }
            
            // Desktop systems initialization  
            if (systemStatus.desktopModeActive) {
                try {
                    // Desktop enhancements are handled by SystemLoader
                    showNotification("🖥️ Desktop mode active", "success");
                } catch (error) {
                    console.error('❌ Desktop systems initialization failed:', error);
                }
            }
            
            // Tactical systems initialization
            if (systemStatus.tacticalSystemsActive && systemStatus.loadedSystems.includes('TacticalCombatSystem')) {
                try {
                    // Tactical systems are initialized by SystemLoader
                    showNotification("⚔️ Tactical systems ready", "success");
                } catch (error) {
                    console.error('❌ Tactical systems initialization failed:', error);
                    showNotification("⚠️ Basic combat mode", "warning");
                }
            }
        }
        
        /**
         * Get platform-specific welcome message
         */
        function getPlatformWelcomeMessage() {
            const systemStatus = systemLoader.getSystemStatus();
            
            if (systemStatus.mobileModeActive) {
                return "📱 Welcome to MyHoMM Mobile! Tap castles to manage them.";
            } else if (systemStatus.desktopModeActive) {
                return "🖥️ Welcome to MyHoMM! Click castles to manage, right-click to move units.";
            } else {
                return "🎮 Welcome to MyHoMM! Click on castles to manage them.";
            }
        }
        
        /**
         * Setup initial game state
         */
        function setupInitialGameState() {
            // Set default environment for tactical system
            if (game.tacticalCombat) {
                game.currentTerrain = 'PLAINS';
                game.currentWeather = 'CLEAR';
            }
            
            // Add AI players
            if (game.systems && game.systems.ai) {
                // Add 2 AI players with different personalities
                game.systems.ai.registerAIPlayer('AI Player 1', 'aggressive');
                game.systems.ai.registerAIPlayer('AI Player 2', 'defensive');
            }
        }
        
        /**
         * Start main game loop
         */
        function startGameLoop() {
            function gameLoop() {
                if (gameRunning && !gamePaused && gameInitialized) {
                    const currentTime = Date.now();
                    const deltaTime = currentTime - lastUpdateTime;
                    
                    // Update game
                    if (game && game.update) {
                        game.update(deltaTime);
                    }
                    
                    lastUpdateTime = currentTime;
                }
                
                requestAnimationFrame(gameLoop);
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        /**
         * Setup game UI and event handlers
         */
        function setupGameUI() {
            // Setup canvas sizing
            resizeCanvas();
            
            // Setup event listeners
            window.addEventListener('resize', resizeCanvas);
            window.addEventListener('orientationchange', () => {
                setTimeout(resizeCanvas, 100);
            });
            
            // Setup selection handlers
            setupSelectionHandlers();
            
            // Start UI update intervals
            startUIUpdates();
            
            // Setup game status updates
            updateGameStatus();
        }
        
        /**
         * Resize canvas to fit screen
         */
        function resizeCanvas() {
            const canvas = document.getElementById('gameCanvas');
            const container = document.querySelector('.game-main');
            
            if (canvas && container) {
                const containerRect = container.getBoundingClientRect();
                canvas.width = containerRect.width;
                canvas.height = containerRect.height;
                
                // Update game renderer if available
                if (game && game.ui && game.ui.renderer) {
                    game.ui.renderer.onResize(canvas.width, canvas.height);
                }
            }
        }
        
        /**
         * Setup selection event handlers
         */
        function setupSelectionHandlers() {
            const canvas = document.getElementById('gameCanvas');
            
            if (canvas) {
                canvas.addEventListener('click', handleCanvasClick);
                canvas.addEventListener('touchstart', handleCanvasTouchStart);
            }
            
            // Listen for selection change events
            window.addEventListener('castleSelected', (event) => {
                updateSelectionInfo('castle', event.detail.castle);
            });
            
            window.addEventListener('armySelected', (event) => {
                updateSelectionInfo('army', event.detail.army);
            });
        }
        
        /**
         * Handle canvas click events
         */
        function handleCanvasClick(event) {
            if (!game || !gameRunning) return;
            
            const rect = event.target.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // Pass click to game input handler
            if (game.ui && game.ui.inputHandler) {
                game.ui.inputHandler.handleClick(x, y);
            }
        }
        
        /**
         * Handle canvas touch events
         */
        function handleCanvasTouchStart(event) {
            event.preventDefault();
            
            if (!game || !gameRunning) return;
            
            const touch = event.touches[0];
            const rect = event.target.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            // Pass touch to mobile touch manager if available
            if (game.mobile && game.mobile.touchManager) {
                // Touch manager will handle this automatically
            } else {
                // Fallback to click handler
                handleCanvasClick({ clientX: touch.clientX, clientY: touch.clientY, target: event.target });
            }
        }
        
        /**
         * Start UI update intervals
         */
        function startUIUpdates() {
            // Update HUD every second
            hudUpdateInterval = setInterval(() => {
                if (gameRunning && game) {
                    updateGameHUD();
                }
            }, 1000);
            
            // Update status every 2 seconds
            statusUpdateInterval = setInterval(() => {
                if (gameRunning && game) {
                    updateGameStatus();
                }
            }, 2000);
        }
        
        /**
         * Update game HUD display
         */
        function updateGameHUD() {
            if (!game || !game.players) return;
            
            const humanPlayer = game.players.find(p => p.isHuman);
            if (!humanPlayer) return;
            
            // Update player info
            document.getElementById('playerName').textContent = humanPlayer.name || 'Human Player';
            document.getElementById('playerGold').textContent = humanPlayer.resources?.gold || 0;
            
            // Update castle count
            const playerCastles = game.castles ? game.castles.filter(c => c.owner === humanPlayer).length : 0;
            document.getElementById('playerCastles').textContent = playerCastles;
            
            // Update population (total units in all castles)
            let totalPopulation = 0;
            if (game.castles) {
                game.castles.forEach(castle => {
                    if (castle.owner === humanPlayer) {
                        totalPopulation += castle.getTotalUnits ? castle.getTotalUnits() : 0;
                    }
                });
            }
            document.getElementById('playerPopulation').textContent = totalPopulation;
            
            // Update total power
            let totalPower = 0;
            if (game.armies) {
                game.armies.forEach(army => {
                    if (army.owner === humanPlayer) {
                        if (game.mobile && game.mobile.combatSystem) {
                            totalPower += game.mobile.combatSystem.calculateArmyPower(army);
                        } else {
                            totalPower += army.unitCount || 0;
                        }
                    }
                });
            }
            document.getElementById('playerPower').textContent = totalPower;
        }
        
        /**
         * Update game status display
         */
        function updateGameStatus() {
            const statusEl = document.getElementById('gameStatus');
            if (!statusEl) return;
            
            // Update system status
            const indicator = statusEl.querySelector('.status-indicator');
            if (indicator) {
                if (gameRunning && game) {
                    indicator.className = 'status-indicator status-active';
                    if (statusEl.firstElementChild) {
                        statusEl.firstElementChild.textContent = 'Game Systems: Active';
                    }
                } else {
                    indicator.className = 'status-indicator status-inactive';
                    if (statusEl.firstElementChild) {
                        statusEl.firstElementChild.textContent = 'Game Systems: Inactive';
                    }
                }
            }
            
            // Update mobile status
            const mobileStatusEl = document.getElementById('mobileStatus');
            if (mobileStatusEl) {
                const isMobileActive = game && game.mobile && game.mobile.isActive;
                mobileStatusEl.textContent = `Mobile: ${isMobileActive ? 'Active' : 'Inactive'}`;
            }
            
            // Update tactical status
            const tacticalStatusEl = document.getElementById('tacticalStatus');
            if (tacticalStatusEl) {
                const isTacticalActive = game && game.tacticalCombat;
                tacticalStatusEl.textContent = `Tactical: ${isTacticalActive ? 'Active' : 'Inactive'}`;
            }
            
            // Update AI status
            const aiStatusEl = document.getElementById('aiStatus');
            if (aiStatusEl && game && game.players) {
                const aiPlayerCount = game.players.filter(p => !p.isHuman).length;
                aiStatusEl.textContent = `AI Players: ${aiPlayerCount}`;
            }
            
            // Update game time
            const gameTimeEl = document.getElementById('gameTime');
            if (gameTimeEl) {
                const gameTime = Date.now() - gameStartTime;
                const minutes = Math.floor(gameTime / 60000);
                const seconds = Math.floor((gameTime % 60000) / 1000);
                gameTimeEl.textContent = `Time: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        /**
         * Update selection info panel
         */
        function updateSelectionInfo(type, object) {
            const selectionInfo = document.getElementById('selectionInfo');
            const selectionTitle = document.getElementById('selectionTitle');
            const selectionDetails = document.getElementById('selectionDetails');
            
            if (!selectionInfo || !selectionTitle || !selectionDetails) return;
            
            if (type === 'castle' && object) {
                selectionTitle.textContent = `🏰 ${object.name || `Castle ${object.id}`}`;
                
                let details = `<div class="selection-stats">`;
                details += `<div>Owner: ${object.owner?.name || 'Unknown'}</div>`;
                details += `<div>Gold Production: ${object.goldProduction || 0}/sec</div>`;
                details += `<div>Total Units: ${object.getTotalUnits ? object.getTotalUnits() : 0}</div>`;
                
                if (object.specialization && game.castleSpecialization) {
                    const spec = game.castleSpecialization.getCastleSpecialization(object);
                    if (spec) {
                        details += `<div>Specialization: ${spec.data.name}</div>`;
                    }
                }
                
                details += `</div>`;
                selectionDetails.innerHTML = details;
                
                selectionInfo.classList.add('visible');
                
            } else if (type === 'army' && object) {
                selectionTitle.textContent = `⚔️ Army`;
                
                let details = `<div class="selection-stats">`;
                details += `<div>Owner: ${object.owner?.name || 'Unknown'}</div>`;
                details += `<div>Unit Count: ${object.unitCount || 0}</div>`;
                
                if (game.mobile && game.mobile.combatSystem) {
                    const power = game.mobile.combatSystem.calculateArmyPower(object);
                    details += `<div>Total Power: ${power}</div>`;
                }
                
                if (object.formation) {
                    details += `<div>Formation: ${object.formation}</div>`;
                }
                
                details += `</div>`;
                selectionDetails.innerHTML = details;
                
                selectionInfo.classList.add('visible');
                
            } else {
                selectionInfo.classList.remove('visible');
            }
        }
        
        /**
         * Game control functions
         */
        function togglePause() {
            gamePaused = !gamePaused;
            
            const pauseIcon = document.getElementById('pauseIcon');
            const pauseText = document.getElementById('pauseText');
            
            if (gamePaused) {
                pauseIcon.textContent = '▶️';
                pauseText.textContent = 'Resume';
                showNotification("⏸️ Game paused", "info");
            } else {
                pauseIcon.textContent = '⏸️';
                pauseText.textContent = 'Pause';
                showNotification("▶️ Game resumed", "info");
            }
        }
        
        function showGameMenu() {
            // Simple menu options
            const menuOptions = [
                '🔄 Restart Game',
                '📊 Game Statistics', 
                '⚙️ Settings',
                '❓ Help'
            ];
            
            // For now, just show a notification
            showNotification("🔧 Game menu - Feature coming soon!", "info");
        }
        
        function toggleTacticalPanel() {
            if (game && game.tacticalUI) {
                const panel = document.getElementById('tacticalPanel');
                if (panel) {
                    if (panel.classList.contains('visible')) {
                        panel.classList.remove('visible');
                        showNotification("📊 Tactical panel hidden", "info");
                    } else {
                        panel.classList.add('visible');
                        showNotification("⚔️ Tactical panel shown", "info");
                    }
                }
            } else {
                showNotification("⚠️ Tactical systems not available", "warning");
            }
        }
        
        /**
         * Log script loading diagnostics for debugging
         */
        function logScriptLoadingDiagnostics() {
            const requiredClasses = [
                'PlatformDetector', 'SystemLoader', 
                'Player', 'Castle', 'Army',
                'ProductionSystem', 'CombatSystem', 'MovementSystem', 'AISystem',
                'InputHandler', 'Renderer', 'Game'
            ];
            
            const loaded = [];
            const missing = [];
            
            requiredClasses.forEach(className => {
                if (typeof window[className] !== 'undefined') {
                    loaded.push(className);
                } else {
                    missing.push(className);
                }
            });
            
            console.log(`   ✅ Loaded (${loaded.length}/${requiredClasses.length}):`, loaded);
            if (missing.length > 0) {
                console.log(`   ❌ Missing (${missing.length}):`, missing);
            }
            
            // Check for script errors
            const scriptTags = document.querySelectorAll('script[src]');
            console.log(`   📄 Script tags found: ${scriptTags.length}`);
            
            if (typeof scriptErrors !== 'undefined' && scriptErrors.length > 0) {
                console.log(`   💥 Script errors: ${scriptErrors.length}`, scriptErrors);
            }
            
            // List all constructor-like objects in window
            const windowConstructors = Object.getOwnPropertyNames(window)
                .filter(prop => typeof window[prop] === 'function' && prop[0] === prop[0].toUpperCase())
                .filter(prop => prop.length > 2 && !['Object', 'Array', 'Function', 'String', 'Number', 'Boolean', 'Date', 'RegExp', 'Error'].includes(prop));
            console.log(`   🏗️ Available constructors: ${windowConstructors.slice(0, 10).join(', ')}${windowConstructors.length > 10 ? '...' : ''}`);
        }
        
        /**
         * Utility functions
         */
        function updateLoadingProgress(percent, text) {
            const fill = document.getElementById('loadingFill');
            const loadingText = document.getElementById('loadingText');
            
            if (fill) fill.style.width = `${percent}%`;
            if (loadingText && text) loadingText.textContent = text;
        }
        
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `game-notification ${type}`;
            notification.textContent = message;
            
            const area = document.getElementById('notificationArea');
            area.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        area.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }
        
        /**
         * Track script loading errors
         */
        const scriptErrors = [];
        window.addEventListener('error', (event) => {
            if (event.filename && event.filename.includes('.js')) {
                scriptErrors.push({
                    file: event.filename,
                    line: event.lineno,
                    error: event.message
                });
                console.error(`💥 Script error in ${event.filename}:${event.lineno} - ${event.message}`);
            }
        });
        
        /**
         * Initialize game when page loads
         */
        window.addEventListener('load', () => {
            console.log('🏰 MyHoMM starting...');
            
            // Report any script errors
            if (scriptErrors.length > 0) {
                console.error('🚨 Script errors detected during loading:', scriptErrors);
            }
            
            // Add small delay to ensure all scripts are loaded
            setTimeout(() => {
                initializeGame();
            }, 500);
        });
        
        /**
         * Handle page visibility changes
         */
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Page backgrounded - pause if running
                if (gameRunning && !gamePaused) {
                    togglePause();
                }
            }
        });
        
        /**
         * Global error handler
         */
        window.addEventListener('error', (event) => {
            console.error('Game error:', event.error);
            if (event.error && event.error.message) {
                showNotification(`❌ Error: ${event.error.message}`, 'error');
            } else if (event.message) {
                showNotification(`❌ Error: ${event.message}`, 'error');
            } else {
                showNotification(`❌ An error occurred`, 'error');
            }
        });
        
        // Also handle unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            if (event.reason && event.reason.message) {
                showNotification(`❌ Promise Error: ${event.reason.message}`, 'error');
            } else {
                showNotification(`❌ A promise error occurred`, 'error');
            }
        });
        
        // Expose game instance globally for debugging
        window.myHoMM = {
            game: () => game,
            pause: togglePause,
            restart: () => location.reload(),
            showStats: () => console.log('Game stats:', {
                initialized: gameInitialized,
                running: gameRunning,
                paused: gamePaused,
                players: game?.players?.length || 0,
                castles: game?.castles?.length || 0,
                armies: game?.armies?.length || 0
            })
        };
        
        console.log('🎮 MyHoMM game functions available at window.myHoMM');
    </script>
</body>
</html>